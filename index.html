<!-- This is a simple lamp that turns on with a button. See the file button.html -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lamp</title>
  </head>
  <body>
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <div id="myDiv" style="width: 100%; max-width: 1000px; height: 600px; margin: 0 auto;"></div>
    <div id="missingMarkers" style="margin-top: 16px; font-family: sans-serif"></div>
  </body>
  <script>
    // Carga los datos y crea un gráfico de barras simple.
    fetch('data.json')
      .then((r) => r.json())
      .then((data) => {
        // Filtra entradas válidas y copia para no mutar
        const rows = data.filter(d => d.LifeExpectancy != null && d.PublicHealthSpendingPerCapita != null).slice();

        // Ordenar por esperanza de vida de menos a más (ascendente)
        rows.sort((a,b) => a.LifeExpectancy - b.LifeExpectancy);

        // Construir arrays
        const countries = rows.map(r => r.Country);
        const lifeExp = rows.map(r => r.LifeExpectancy);
        const spending = rows.map(r => r.PublicHealthSpendingPerCapita);

        // Colores por defecto
        const defaultColor = '#4682B4';
        const highlightColor = '#FF4136';
        let colors = countries.map(() => defaultColor);

        const trace = {
          x: countries,
          y: spending,
          type: 'bar',
          marker: { color: colors },
          hovertemplate: '%{x}<br>LifeExp: %{customdata[0]}<br>Spending: %{y}<extra></extra>',
          customdata: lifeExp.map(v => [v])
        };

        const layout = {
          title: 'Gasto público per cápita vs Esperanza de Vida por País',
          xaxis: { title: 'País (ordenado por esperanza de vida)', automargin: true, tickangle: -45, showticklabels: false },
          yaxis: { title: 'PublicHealthSpendingPerCapita' },
          annotations: []
        };

        Plotly.newPlot('myDiv', [trace], layout, {responsive: true});

        // Función auxiliar para encontrar country por valor de marker
        // TEMPORAL: testMarkerMap permite mapear marcadores de prueba a países.
        const testMarkerMap = {
          '100': 'Chile',
          '200': 'Nauru',
          '300': 'Albania',
          '400': 'United States'
        };

        function findCountryForMarker(marker) {
          const m = String(marker).trim();
          // 0) Mapeo temporal de prueba (remover después)
          if (testMarkerMap[m]) return testMarkerMap[m];
          // 1) Buscar por CODE (código ISO)
          const byCode = rows.find(r => String(r.CODE).toUpperCase() === m.toUpperCase());
          if (byCode) return byCode.Country;
          // 2) Buscar por nombre de país exacto (case-insensitive)
          const byName = rows.find(r => String(r.Country).toLowerCase() === m.toLowerCase());
          if (byName) return byName.Country;
          // 3) si marker es un número, intentar usar como índice (1-based)
          const n = Number(m);
          if (!Number.isNaN(n) && n > 0 && Number.isInteger(n) && n <= rows.length) {
            return rows[n-1].Country;
          }
          return null;
        }

        // Manejo centralizado de 'missing' para poder invocarlo desde pruebas.
        function handleMissing(missing) {
          const missingCountries = (missing || []).map(findCountryForMarker).filter(Boolean);

          // Actualiza colores: resaltar los países que faltan (missing)
          colors = countries.map(c => missingCountries.includes(c) ? highlightColor : defaultColor);
          Plotly.restyle('myDiv', {'marker.color': [colors]});

          // Crear anotaciones (flechas) apuntando a la cima de la barra (valor de spending)
          const annotations = missingCountries.map(c => {
            const idx = countries.indexOf(c);
            const yVal = idx >= 0 ? spending[idx] : 0;
            return {
              x: c,
              y: yVal,
              xref: 'x',
              yref: 'y',
              text: c,
              showarrow: true,
              arrowhead: 3,
              arrowcolor: highlightColor,
              font: { color: highlightColor },
              ay: -40,
              ax: 0,
              yanchor: 'bottom'
            };
          });

          Plotly.relayout('myDiv', {annotations: annotations});
        }

        // Escucha los datos recibidos desde Protobject y resalta países que están "missing"
        Protobject.Core.onReceived((payload) => {
          const missing = Array.isArray(payload) ? [] : payload?.missing || [];
          handleMissing(missing);
        });

        // --- TEMPORAL: botones simples para probar cada marker (remover después) ---
        const testDiv = document.createElement('div');
        testDiv.style.marginTop = '8px';
        testDiv.innerHTML = '<strong>Pruebas temporales:</strong> ';
        ['100','200','300','400'].forEach(code => {
          const btn = document.createElement('button');
          btn.textContent = code;
          btn.style.marginLeft = '6px';
          btn.onclick = () => handleMissing([code]);
          testDiv.appendChild(btn);
        });
        document.body.appendChild(testDiv);
        // ---------------------------------------------------------------------------
      })
      .catch((err) => {
        console.error('Error cargando data.json', err);
      });
  </script>
</html>
