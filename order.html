<!-- This page defines the button -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Button</title>
  </head>
  <body>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>
    <video id="cameraPreview" autoplay playsinline style="width: 640px; height: 360px; border: 1px solid #ccc; display: block; margin-top: 8px;"></video>
    <div id="detectedMarkers" style="margin-top:8px; font-family: sans-serif;"></div>
    <script>
      // Primero solicitar permisos de cámara explícitamente
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
      .then(function(stream) {
        cameraStream = stream;
        // Conecta el stream al elemento <video> para vista previa
        const vid = document.getElementById('cameraPreview');
        if (vid) vid.srcObject = stream;
        updateStatus('Permiso de cámara otorgado');
      });

      // Inicializa el sistema de detección de marcadores Aruco
      Protobject.Aruco.start(30, 1); // La cámara genera eventos cada 30 ms y utiliza la cámara con id 1
      Protobject.Aruco.showPreview({ top: 0, left: 0, width: 1280 / 3, height: 720 / 3 }); // Muestra la vista previa de la cámara

      // Identificadores de marcadores que se desea verificar
      const markerIds = [100, 200, 300, 400];

      // Escucha los datos de los marcadores Aruco
      Protobject.Aruco.onData((data) => {
        //console.log(data); // Muestra los datos en la consola para depuración

        let markers = []; // Array para almacenar los marcadores detectados

        // Recorre los identificadores de marcadores y verifica su presencia en los datos
        for (const id of markerIds) {
          if (data[id]) {
            // Si el marcador está presente, guarda su id y posición en el eje Y
            markers.push({ id: id, y: data[id].position.y });
          }
        }

        // Ordena los marcadores detectados en función de su posición en el eje Y (de arriba hacia abajo)
        markers.sort((a, b) => b.y - a.y);

        // Crea un nuevo array que contiene solo los IDs de los marcadores en el orden determinado
        let orderPosition = markers.map(marker => marker.id);

        // Actualiza la vista con los marcadores detectados
        const detectedDiv = document.getElementById('detectedMarkers');
        if (detectedDiv) {
          detectedDiv.textContent = 'Detectados: ' + (orderPosition.length ? orderPosition.join(', ') : 'Ninguno');
        }

        // Identifica los marcadores que dejaron de detectarse
        const missingMarkers = markerIds.filter((id) => !data[id]);

        // Envía la información de detectados y no detectados al sistema principal
        Protobject.Core.send({
          detected: orderPosition,
          missing: missingMarkers,
        }).to("index.html");
      });
    </script>
  </body>
</html>
